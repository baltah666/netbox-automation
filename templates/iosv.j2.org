# jinja2: lstrip_blocks: True, trim_blocks: True
no service pad
service tcp-keepalives-in
service tcp-keepalives-out
service timestamps debug datetime msec localtime show-timezone year
service timestamps log datetime msec localtime show-timezone year
service password-encryption
service linenumber
service compress-config
service sequence-numbers
!
hostname {{ device.json.results[0]['name'] }}
!
boot-start-marker
boot-end-marker
!
vrf definition Mgmt-intf
 address-family ipv4
 exit-address-family
 address-family ipv6
 exit-address-family
!
aaa new-model
no ip bootp server
spanning-tree extend system-id
lldp run

archive
 log config
  logging enable
  notify syslog contenttype plaintext
  hidekeys

!
{% for intf in interfaces.json.results %}
{% set intf_ips = ip_addresses.json.results | selectattr('assigned_object.name', 'equalto', intf.name) | list %}
{% set has_ip = intf_ips | length > 0 %}
{% if intf.name.startswith('vlan.') %}
interface vlan {{ intf.name.split('.')[1] }}
{% else %}
interface {{ intf.name }}
{% endif %}
{% if intf.description %}
  description {{ intf.description }}
{% endif %}
{% if intf.name.startswith('vlan.') %}
{% for ip in intf_ips %}
  ip address {{ ip.address.split('/')[0] }} {{ ip.address | ansible.utils.ipaddr('netmask') }}
{% endfor %}
  no shutdown
{% else %}
  {% if has_ip %}
  no switchport
{% for ip in intf_ips %}
  ip address {{ ip.address.split('/')[0] }} {{ ip.address | ansible.utils.ipaddr('netmask') }}
{% endfor %}
  no shutdown
  {% elif intf.mode and intf.mode.value == "access" %}
  switchport mode access
  switchport access vlan {{ intf.untagged_vlan.vid }}
  no shutdown
  {% elif intf.mode and intf.mode.value in ["tagged", "tagged-all"] %}
  switchport mode trunk
{% if intf.tagged_vlans %}
  switchport trunk allowed vlan {{ intf.tagged_vlans | map(attribute='vid') | join(',') }}
{% endif %}
  no shutdown
  {% else %}
  shutdown
  {% endif %}
{% endif %}
!
{% endfor %}
snmp-server community {{ device.json.results[0].config_context['snmp-ro-community'] }} RO
{% set latitude = site.json.results[0]['latitude'] %}
{% set longitude = site.json.results[0]['longitude'] %}
{% if latitude and longitude %}
snmp-server location {{ site.json.results[0]['region']['name'] }} [{{ latitude }},{{ longitude }}]
{% else %}
snmp-server location {{ site.json.results[0]['region']['name'] }}
{% endif %}
!
logging source-interface GigabitEthernet3/3
{% for syslog_server in device.json.results[0].config_context['syslog-servers'] %}
logging host {{ syslog_server }} transport udp port 1514
{% endfor %}
!
{% for ntp_server in device.json.results[0].config_context['ntp-servers'] %}
ntp server {{ ntp_server }}
{% endfor %}
!
{% for tacacs in device.json.results[0].config_context['tacacs-servers'] %}
tacacs server {{ tacacs.name }}
  address ipv4 {{ tacacs.address }}
  port {{ tacacs.port }}
  key {{ tacacs.key }}
  single-connection
!
{% endfor %}
!
aaa group server tacacs+ Techit_Tac_Grp
{% for tacacs in device.json.results[0].config_context['tacacs-servers'] %}
  server name {{ tacacs.name }}
{% endfor %}
!
{% for name_server in device.json.results[0].config_context['name-servers'] %}
ip name-server {{ name_server }}
{% endfor %}
!
banner exec ^C
**************************************************************************
* IOSv is strictly limited to use for evaluation, demonstration and IOS  *
* education. IOSv is provided as-is and is not supported by Cisco's      *
* Technical Advisory Center. Any use or disclosure, in whole or in part, *
* of the IOSv Software or Documentation to any third party for any       *
* purposes is expressly prohibited except as otherwise authorized by     *
* Cisco in writing.                                                      *
**************************************************************************^C
banner incoming ^C
**************************************************************************
* IOSv is strictly limited to use for evaluation, demonstration and IOS  *
* education. IOSv is provided as-is and is not supported by Cisco's      *
* Technical Advisory Center. Any use or disclosure, in whole or in part, *
* of the IOSv Software or Documentation to any third party for any       *
* purposes is expressly prohibited except as otherwise authorized by     *
* Cisco in writing.                                                      *
**************************************************************************^C
banner login ^C
**************************************************************************
* IOSv is strictly limited to use for evaluation, demonstration and IOS  *
* education. IOSv is provided as-is and is not supported by Cisco's      *
* Technical Advisory Center. Any use or disclosure, in whole or in part, *
* of the IOSv Software or Documentation to any third party for any       *
* purposes is expressly prohibited except as otherwise authorized by     *
* Cisco in writing.                                                      *
**************************************************************************^C
!
line con 0
 exec-timeout 30 0
 authorization exec Console_AAA
 logging synchronous
 login authentication Console_AAA
 transport preferred none
 stopbits 1
line aux 0
 stopbits 1
line vty 0 4
 logging synchronous
 session-timeout 30
 exec-timeout 30 0
 authorization commands 1 Remote_AAA
 authorization commands 15 Remote_AAA
 authorization exec Remote_AAA
 accounting commands 1 Remote_AAA
 accounting commands 15 Remote_AAA
 accounting exec Remote_AAA
 logging synchronous
 login authentication Remote_AAA
 transport preferred none
 transport input all
line vty 5 15
 logging synchronous

end
